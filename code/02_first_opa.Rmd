---
title: "OPA for Wealth Tax"
author: ''
date: "1/28/2019"
output:
  html_document:
    code_folding: hide
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = "/Users/fhoces/Desktop/sandbox/opa-wealthtax")
#knitr::opts_knit$set(root.dir = "C:/Users/clanc/o-lab/opa-wealthtax")
library(tidyverse)
library(haven)
library(EnvStats)
library(here)
library(ggvis)

###Outline:
###Params (no narrative)
###1 - Policy
###2 - Elasticity calculation
###3 - Relevant universe
###4 - 
```


# Wealth tax analysis


```{r params, echo=TRUE, message=FALSE, warning=FALSE}
# - inputs: none
# - outputs: all the original source values
call_params_f <- function(){
  
  
  
    ################  
    ####### Research:
    ################  
    research_so <- read_csv("rawdata/research.csv")      #load data set that contains parameters from research
    # Elasticities
    ela1_so <- as.numeric(research_so[1,"param"])           # 0.5 - David. 2017
    ela2_so <- as.numeric(research_so[2,"param"])           # 0.5 - Jakobsen et al. 2018
    ela3_1_so <- as.numeric(research_so[3,"param"])         # 2   - Londono-Velez 2018
    ela3_2_so <-   as.numeric(research_so[4,"param"])       # 3   - Londono-Velez 2018
    ela4_1_so <- as.numeric(research_so[5,"param"])         # 23  - Brülhart et al. 2016
    ela4_2_so <- as.numeric(research_so[6,"param"])         # 34  - Brülhart et al. 2016
    
    ################
    ###### Data:
    ################ 
    # Tax base called from data (SCF and DINA) already accounts for the adjustments
    # due to population growth, tax avoidance, 
    # Number of tax payers SCF & DINA
    cum_numberTaxpayers_scf_so <- c(1100144, 298649, 72143, 34552, 7119,  2555,  671)
    cum_numberTaxpayers_dina_so <- c(673449, 194548, 78434, 32751, 10236, 4491, 1597) 
    # Tax base for brackets_po below
    cum_tax_base_scf_so <-  c(203.97, 121.63,  81.79, 59.18, 36.67, 27.46, 20.78)
    cum_tax_base_dina_so <- c(187.35, 135.38, 105.02, 80.11, 53.43, 36.94, 23.39)
    # Total wealth and number if households [SOURCE NEEDED]
    total_wealth_so <- 94e12   # [SOURCE]  
    total_hhlds_so <- 129.4e6  # [SOURCE]
    # Forbes: average across 400 and value for 400th billionare
    average_wealth_top_400_so <- 7.2e9
    wealth_last_400_so <- 2.1e9
    # Macro-economy/demographics
    inflation_so <- 0.025      # CBO/JCT
    population_gr_so <- 0.01   # CBO/JCT
    real_growth_so <- 0.02     # CBO/JCT
    
    ################ 
    #####  Guesswork:
    ################ 
    hhld_gr_so <- 0.009
    growth_wealth_so <- 0.055

    return( sapply( ls(pattern= "_so\\b"), function(x) get(x) ) ) 
}
invisible( list2env(call_params_f(),.GlobalEnv) )


################ 
#####  Notes:
################ 
### Source ---------->  Input ---------->  Model ---------->  Policy Estimates (output)
###  (_so)              (_in)              (_mo)                (_pe)
### values            functions          functions              values
###                   & values           & values             
# - call_params_f - tax_elasticity_in_f  - tax_revenue_mo_f     - ten_year_revenue_pe
# - policy_f      - est_billionares_in_f - total_rev_mo_f       - ten_year_top_tax_pe
#                                        - ten_years_mo_f       - total_rev_pe
### arguments in functions should used "_var" and functions should "_f"

```


### 1 - Policy choices

The wealth tax applies to net worth (sum of all assets net of debts) above $50 million dollars, and follows the following structure:

```{r policy}
# - inputs: none
# - outputs: all the original source values
#### Policy:  
policy_f <- function(){
  
  
  
    # brackets_po
    brackets_po <- c(10, 25, 50, 100, 250, 500,  1000) * 1e6
    tax_rates_po <- c(  0,    0, 0.02,  0.02,  0.02,  0.02, 0.03) 
    starting_brack_po <- brackets_po[min(which(tax_rates_po>0))]
    next_increase_po <- brackets_po[min(which(tax_rates_po>0.02))]
    main_tax_po <- median(tax_rates_po)
    max_tax_po <- max(tax_rates_po)
    
    
    
    return( sapply( ls(pattern= "_po\\b"), function(x) get(x)) ) 
}
invisible( list2env(policy_f(),.GlobalEnv) )
knitr::kable(cbind("Bracket (millions of $)" = brackets_po/1e6,"Marginal Tax Rate (%)" = 100*tax_rates_po) )  
```  

Household net worth above `r paste("$", starting_brack_po/1e6, sep = "")` million would be taxed at `r paste(main_tax_po * 100, "%", sep = "")`. Any wealth over `r paste("$", next_increase_po/1e9, sep = "")` billion would be taxed an additional 1% (a billionaire surtax).

 
### 2 -  Compute tax avoidance elasticity

To calculate the tax revenue from this wealth tax, the extent of wealth tax evasion/avoidance is estimated based on recent research. Recent research shows that the extent of wealth tax evasion/avoidance depends crucially on loopholes and enforcement. The tax-avoidance elasticity is computed as the average elasticity from four studies. The table lists the four studies and the avoidance/evasion response to a 1% wealth tax.

```{r avoid}
# Format the parameters from research into one table
aux1_df <-   research_so %>% 
  group_by(paper_id) %>% 
  mutate(aux1 = row_number()) %>% 
  filter(aux1 ==1) %>% 
  ungroup() %>%  
  select(Authors, Year, paper, Publisher) 
aux2 <- c(ela1_so, ela2_so, paste0(ela3_1_so, "-", ela3_2_so), paste0(ela4_1_so, "-", ela4_2_so))
table_aux <- cbind(aux1_df,  "Avoidance/evasion response" = aux2) 
knitr::kable(table_aux)  
```

Seim (2017) and Jakobsen et al. (2018) obtain small avoidance/evasion responses in the case of Sweden and Denmark, two countries with systematic third party reporting of wealth: a 1% wealth tax reduces reported wealth by less than 1%. Londono-Velez and Avila (2018) show medium avoidance/evasion responses in the case of Colombia where enforcement is not as strong: a 1% wealth tax reduces reported wealth by about `r paste(ela3_1_so, "-", ela3_2_so,"%", sep="")`. The study for Switzerland, Brülhart et al. (2016) is an outlier that finds very large responses to wealth taxation in Switzerland: a 1% wealth tax lowers reported wealth by `r paste(ela4_1_so, "-", ela4_2_so,"%", sep="")`. This extremely large estimate is extrapolated from very small variations in wealth tax rates over time and across Swiss cantons and hence is not as compellingly identified as the other estimates based on large variations in the wealth tax rate. Switzerland has no systematic third party reporting of assets which can also make tax evasion responses larger than in Scandinavia. 

```{r tax-elasticity, warning=FALSE, message=FALSE}   
# input: elasticity parameters from research, main tax, adjutment factor
# ouptut: final elasticity (final_ela_in), evasion parameter (evasion_param_in) 
tax_elasticity_in_f <- function(ela1_var = ela1_so, ela2_var = ela2_so, ela3_1_var = ela3_1_so, 
                                ela3_2_var = ela3_2_so, ela4_1_var = ela4_1_so, ela4_2_var = ela4_2_so,
                                main_tax_var = main_tax_po){
  
  
  
    final_ela_in <- mean(c(ela1_var, ela2_var, (ela3_1_var + ela3_2_var)/2, (ela4_1_var + ela4_2_var)/2))
    evasion_param_in <- main_tax_var * final_ela_in
    
    
    
    return(list("final_ela_in" = final_ela_in, 
                "evasion_param_in" = evasion_param_in))
}
invisible( list2env(tax_elasticity_in_f(),.GlobalEnv) ) 

# ls(pattern = "_in\\b|_in_") 
```

The final `r paste(evasion_param_in * 100,"%", sep="")` tax avoidance/evasion response to a `r paste0(main_tax_po * 100, "%")` wealth tax was computed as and average across these four studies (`r paste0(main_tax_po * 100, "%", "*(", ela1_so, "+", ela2_so, "+" ,(ela3_1_so+ela3_2_so)/2, "+", (ela4_1_so+ela4_2_so)/2, ")/4")`)

### 3 - Data Cleaning [NEEDS CLEANING]

```{r data-cleaning, eval=FALSE, include = FALSE} 

##### Reproducing do file
##### 
yr_val <- 2019
df_forbes <- read_dta("/Users/fhoces/Desktop/opa-wealthtax_test/rawdata/materials/forbes_20112018_bdays.dta")
df_forbes1 <- df_forbes  %>% filter(forbes_yr == 2018) %>% 
  mutate("networth" = net_worthmillions * 1e6, 
           "weight" = 1, 
           "data" = "FB400") %>%
  select(data, networth, weight) %>% 
  filter( !is.na(networth) )
forbesmin <- min(df_forbes1$networth)
f400tot <- sum(df_forbes1$networth * df_forbes1$weight) / 1e12
cat("TOTAL FORBES NETWORTH 2018 (Tr) = ", f400tot,  "FORBES MIN WEALTH 2018 = ", forbesmin)

df_scf <- read_dta("/Users/fhoces/Desktop/opa-wealthtax_test/rawdata/materials/rscfp2016.dta")
totw_scf <- sum(df_scf$networth * df_scf$wgt) / 1e12

cat("TOTAL SCF NETWORTH 2016  (Tr)", totw_scf)

df_scf <- df_scf %>% mutate("wgt" = round( wgt * 1.009^(yr_val-2016)))
totw <- sum(df_scf$networth * df_scf$wgt) / 1e12
totn <- sum(df_scf$wgt)


# Rescaling SCF to match total total wealth reported in DINA excluding the f400
df_scf1 <- df_scf %>% mutate("networth" = networth * ( 94 - f400tot ) / totw, 
                            "weight" = wgt, 
                            "data" = "SCF") %>%
  select(data, networth, weight)


# * DINA 2019 (complete  data  usdina$yr.dta built in usdina project, directory usdina/output/dinafiles)

# use hweal id dweght married using $root/SaezZucman2014/usdina/output/dinafiles/usdina$yr.dta, clear 
# save "$root/bookwebsite/wealthtaxsim/data/usdina$yr.dta"


####### This section uses data that cannot be shared for confidentiality reasons
####### Below is the code used to aggregate the data. 
####### To obtain this data please contact ...
####### The file that you will obtain should have the following signature:
####### ...
df_dina_first <- read_dta("/Users/fhoces/Desktop/opa-wealthtax_test/rawdata/materials/usdina2019.dta")
df_dina <- df_dina_first %>% 
  group_by(id) %>% 
  summarise("networth" = round(sum(hweal)),  # rounding of networth is to make it compatible with Stata
            "weight" = mean(dweght)/1e5) 
  
totw_dina <- sum(df_dina$networth * df_dina$weight) / 1e12
cat("TOTAL DINA NETWORTH 2019  (Tr) ", totw_dina)

totn_dina <- sum(df_dina$weight)

df_dina$data <- "DINA"

# Aggregate info to protect confidentiality
df_dina1 <- df_dina %>% 
  mutate("aux_id" = 1:dim(df_dina)[1]) %>% 
  arrange(desc(networth),aux_id) %>% 
  mutate("group" = floor((1:dim(df_dina)[1] + 3) / 5)) %>% 
  group_by(group) %>% 
  summarise("weight" = sum(weight),
            "networth" = mean(networth)) %>% 
  mutate("data" = "DINA") %>% 
  select("data", "networth", "weight")
write.csv(df_dina1, "dina.csv")

#### End of confidential section

# Combine three data sources
df <- rbind(df_forbes1, df_scf1, df_dina1)

df$weight <- with(df, ifelse(data=="SCF" | data=="DINA", 
                               round(weight/2), weight) )
df <- df %>% filter( !(networth > forbesmin & ( data == "SCF" | data == "DINA" ) ) )

df %>% 
  summarise( mean(networth), sd(networth) ) 

total_wealth <- df %>% 
  summarise(sum(networth * weight) / 1e12) %>% 
  as.numeric()
billio_wealth <- df %>% 
  filter(networth >= 50e6) %>% 
  summarise(sum(networth * weight) / 1e12) %>% 
  as.numeric()

cat("Total wealth (in trillions) is ", total_wealth, ". Wealth for billionares total wealth is ", billio_wealth) 

# Very small differences with stata output (but it should be zero differences!)
# wealth <- read_dta("~/Downloads/wealthtaxsim/data/wealth.dta")
# diff_aux <- abs( df$networth -  wealth$networth )
# summary(abs(diff_aux))
#     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#    0.000    0.000    0.008    0.928    0.174 3328.000 


# save $datawork/wealth.dta, replace

# Add stata call/chunk
# save as wealthperc.xlsx


```

### 4 - Number of affected households and their total tax base [NEEDS CLEANING]

```{r affected hhlds, eval=FALSE}
# tax_base_grid ---> 
grid <- read.csv("interactive_visualization/taxBaseGridUpdated.csv")  %>% 
  filter(!is.na(gperc))
# print(head(grid)) ## check that app has access to this file

# Wealth per bin (percentile) after evasion  
grid$thresNew <- (1 - evasion_param_in) * grid$thres
grid$avgNew <- (1 - evasion_param_in) * grid$avg 
 


###### The following section depends on the cleaning data chunk
if (FALSE){
#QUESTION: Why counts from original source differ?
#    df_dina1 %>% filter(networth>50e6) %>% summarise(sum(weight))
#    grid %>% filter(thresNew>50e6) %>% summarise(sum(nb))
#    df_scf %>% filter(networth>50e6) %>% summarise(sum(weight))
target_hhlds_mo <- df %>% 
  filter(networth>starting_brack_po) %>% 
  summarise(sum(weight)) %>% 
  as.numeric()
target_hhlds_round <- round(target_hhlds_mo/1000) * 1000

target_hhlds_scf_mo <- df_scf1 %>% 
  filter(networth>starting_brack_po) %>% 
  summarise(sum(weight)) %>% 
  as.numeric()
target_hhlds_round_scf <- round(target_hhlds_scf_mo/1000) * 1000

target_hhlds_dina_mo <- df_dina1 %>% 
  filter(networth>starting_brack_po) %>% 
  summarise(sum(weight)) %>% 
  as.numeric()
target_hhlds_round_dina <- round(target_hhlds_dina_mo/1000) * 1000

}

### AFTER THIS LINE I NEED TAX REVENUE
# tax_base_scf_mo  
# tax_base_dina_mo 
# tax_base_total_mo

#num of hhlds DONE
#tatal wealth: before and after evasion
#

#Billionares num of hhlds DONE
#tatal wealth: before and after evasion
#



##### Num hhlds:
#no avoidance
grid %>% filter(thres > starting_brack_po) %>% summarise(sum(nb))
#with avoidance
grid %>% filter(thresNew > starting_brack_po) %>% summarise(sum(nb))

### Billionares:
#no avoidance
grid %>% filter(thres > next_increase_po) %>% summarise(sum(nb))
#with avoidance
grid %>% filter(thresNew > next_increase_po) %>% summarise(sum(nb))

##### Total Taxable Wealth:
grid %>% filter(thres > starting_brack_po) %>% summarise(sum((avg - starting_brack_po) * nb)/1e12)

#with avoidance
#2% above 50m
grid %>% 
  filter(thresNew > starting_brack_po) %>% 
  summarise(sum((avgNew-starting_brack_po) * nb)/1e12)

#billionares additional 1%
grid %>% 
  filter(thresNew > next_increase_po) %>% 
  summarise(sum((avgNew - next_increase_po) * nb)/1e12)




```

#### 4.1 - `r paste0(main_tax_po * 100, "%")` tax to all wealth above `r paste0("$",starting_brack_po/1e6)` millions


#### 4.2 - `r paste0((max_tax_po - main_tax_po) * 100, "%")` additional tax to all wealth above `r paste0("$",next_increase_po/1e9)` billion

### 5 - Total tax revenue (1 year) [CLEAN AND UNDERSTAND DICREPANCIES]

```{r new-tax-rev, eval=FALSE}
#Total tax collected in a year
#amount from 2%
#amount from extra 1%



#This function computes the total tax collected for a tax unit with wealth "wealth_var", applying "taxrates_var" to "brackets_var"
# - inputs: wealth, tax rates, brackets to tax
# - ouputs: total tax collected
getTaxRevenue <- function(wealth_var = wealth_aux, taxrates_var = tax_rates_po,
                          brackets_var = brackets_po) {
    ## expecting taxLevels in percentage
    # taxLevels <- taxLevels / 100
    if (length(brackets_var) != length(taxrates_var)){
      stop("Tax brackets and tax rates do not match")
    }
   # Compute max taxable wealth per bracket
    max_tax_per_brack <- c(diff(c(0, brackets_var)), 1e100)
   # Substract wealth minus tax bracket. If wealth above a given bracket (difference is larger than max taxable wealth), 
   # then assign max taxable wealth to that given bracket
    to_tax <- ifelse( wealth_var - c(0, brackets_var) > max_tax_per_brack, 
                      max_tax_per_brack, 
                      ( wealth_var - c(0,brackets_var) ) )   
   # If wealth if lower than a given bracket (difference between wealth and bracket is negative), then assign zero to that bracket  
    to_tax <- ifelse( to_tax<0, 0, to_tax )
    # Apply trax rates to each corresponding bracket and all together
    total_tax <- sum( to_tax * c(0, taxrates_var) )   
    return(total_tax)
}

#Assigns evaded wealth to brackets
getTaxBasePerBracket=function(grid_var = grid,brackets_var = brackets_po, threshold_var = starting_brack_po){
  ## brackets is lower end of each bracket
  brackets = c(brackets_var, 1e12) ## get last bracket
  # adding one dollar as the threshold represents the lower bound
  grid_var$group=cut(grid_var$thresNew + 1, brackets)
  toReturn = grid_var %>% 
    group_by(group) %>% 
    summarise(taxBase = sum((avgNew - threshold_var) * nb)) %>% 
    drop_na()
  return(toReturn)
}
  
taxBase <- getTaxBasePerBracket(brackets = brackets_po, grid = grid)

#NEED TO UNDERSTAND: why getTaxBasePerBracket differs from below
# computes tax payed by each average wealth per percintile (up to 2%)
aux_test1 <- sapply(grid$avgNew, 
                   function(x) getTaxRevenue(wealth_var = x, 
                                             taxrates_var = c(tax_rates_po[-7], 0.02), 
                                             brackets_var = brackets_po))
# computes tax payed by each average wealth per percintile (billionare surtax of 1%)
aux_test2 <- sapply(grid$avgNew, 
                   function(x) getTaxRevenue(wealth_var = x, 
                                             taxrates_var = c(rep(0,6), 0.01), 
                                             brackets_var = brackets_po))
# computes tax payed by each average wealth per percintile 
aux_test3 <- sapply(grid$avgNew, 
                   function(x) getTaxRevenue(wealth_var = x, 
                                             taxrates_var = tax_rates_po, 
                                             brackets_var = brackets_po))

total_tax_base <- sum(grid$nb * aux_test1)/1e9
total_tax_sur_bill <- sum(grid$nb * aux_test2)/1e9
total_tax_total <- sum(grid$nb * aux_test3)/1e9



# The following replicates stata code more closely UNDERSTAND WHY
#with avoidance
#2% above 50m
asd1 <- grid %>% 
  filter(thresNew > starting_brack_po) %>% 
  summarise(sum((avgNew-starting_brack_po) * nb * 0.02)/1e9)

#billionares additional 1%
asd2 <- grid %>% 
  filter(thresNew > next_increase_po) %>% 
  summarise(sum((avgNew - next_increase_po) * nb * 0.01)/1e9)


asd1 + asd2



getPeoplePerBracket=function(grid,brackets){
  brackets = c(brackets, 1e12) ## get last bracket
  grid$group=cut(grid$thresNew,brackets)
  toReturn = grid %>% 
    group_by(group) %>% 
    summarise(totalPeople=sum(nb)) %>% 
    drop_na()
  return(toReturn)
}
  

numberTaxpayers <- getPeoplePerBracket(brackets = brackets_po, grid = grid)

#Revenue
#From here on: keep
target_hhlds_mo <- sum( numberTaxpayers$totalPeople[brackets_po>=starting_brack_po] )

#go with wealthperc and highlight discrepe =   
#tax_base_total_mo <- sum(taxBase$taxBase[brackets_po>=starting_brack_po])/1e12* main_tax_po * 1000
#tax_rev_init_mo <-   tax_base_total_mo * main_tax_po * 1000

tax_rev_init_mo <- total_tax_base
```


```{r est-billionares-to-delete, eval=TRUE}  
# TO DELETE?

# - inputs: evasion_param_in, wealth_last_400_so, average_wealth_top_400_so,  
# cum_numberTaxpayers_scf_so, cum_numberTaxpayers_dina_so, cum_tax_base_scf_so,  
# cum_tax_base_dina_so 
# - outputs: non_evaded_tax_in, totax_last_400_in, totax_average_400_in, totax_total_400_in, 
# pareto_scale_in, ratio1_in, missing_fraction_in, missing_taxbase_in, num_billionares_in, 
# final_taxbase_b_in, top_tax_base_in, cum_numberTaxpayers_scf_in, cum_numberTaxpayers_dina_in, 
# cum_tax_base_scf_in, cum_tax_base_dina_in 
est_billionares_in_f <- function(evasion_param_var = evasion_param_in, 
                                 wealth_last_400_var = wealth_last_400_so,
                                 average_wealth_top_400_var = average_wealth_top_400_so,
                                 cum_numberTaxpayers_scf_var = cum_numberTaxpayers_scf_so,
                                 cum_numberTaxpayers_dina_var = cum_numberTaxpayers_dina_so, 
                                 cum_tax_base_scf_var = cum_tax_base_scf_so, 
                                 cum_tax_base_dina_var = cum_tax_base_dina_so){
    non_evaded_tax_in <- (1 - evasion_param_var)
     
    # Post evasion taxable wealth
    totax_last_400_in <- non_evaded_tax_in * wealth_last_400_var/1e9                 
    totax_average_400_in <- non_evaded_tax_in * average_wealth_top_400_var/1e9       
    totax_total_400_in <- 400 * (totax_average_400_in - 1)                     # above one billion
      
    # Compute pareto scale of wealth distribution
    aux1 <- average_wealth_top_400_var/wealth_last_400_var
    pareto_scale_in <- aux1/(aux1-1) 
    ratio1_in <- round(aux1, 1)
    
    # Compute missing fraction of taxable wealth above 1 billion
    one_billion <- 1 
    missing_fraction_in <- ( totax_last_400_in / one_billion )^( pareto_scale_in - 1 ) - 1

    # Compute missing wealth (billions of dollars) to tax above one billion dollars
    missing_taxbase_in <- missing_fraction_in * totax_total_400_in

    # Compute total number of billionares. Extrapolation from forbes 400. 
    #Diff between original document (911) and below (906) is due to rounding in inputs 
    num_billionares_in <- 400 * ( totax_last_400_in / 1 ) ^ pareto_scale_in 
    final_taxbase_b_in <- totax_total_400_in + missing_taxbase_in

    #This is the taxed money (the aboves is the totale taxable) in billions  (minus one is just to match original results)
    top_tax_base_in <- final_taxbase_b_in * 0.01                                     # ALERT: Hard coded number
     
    #edit the number of billionares
    cum_numberTaxpayers_scf_in <- c(cum_numberTaxpayers_scf_var[1:6], num_billionares_in)
    cum_numberTaxpayers_dina_in <- c(cum_numberTaxpayers_dina_var[1:6], num_billionares_in)
    #edit the tax revenue for billionares    
    cum_tax_base_scf_in <- c(cum_tax_base_scf_var[1:6], top_tax_base_in)
    cum_tax_base_dina_in <- c(cum_tax_base_dina_var[1:6], top_tax_base_in)
    
    return( list( "non_evaded_tax_in" = non_evaded_tax_in, "totax_last_400_in" = totax_last_400_in, 
                  "totax_average_400_in" = totax_average_400_in, "totax_total_400_in" = 
                    totax_total_400_in, "pareto_scale_in" = pareto_scale_in, "ratio1_in" = ratio1_in, 
                  "missing_fraction_in" = missing_fraction_in, "missing_taxbase_in" = 
                    missing_taxbase_in, "num_billionares_in" = num_billionares_in, 
                  "final_taxbase_b_in" = final_taxbase_b_in, "top_tax_base_in" = top_tax_base_in, 
                  "cum_numberTaxpayers_scf_in" = cum_numberTaxpayers_scf_in, 
                  "cum_numberTaxpayers_dina_in" = cum_numberTaxpayers_dina_in, 
                  "cum_tax_base_scf_in" = cum_tax_base_scf_in, 
                  "cum_tax_base_dina_in" = cum_tax_base_dina_in ) )
}

invisible( list2env(est_billionares_in_f(),.GlobalEnv) )
#rm(list = c("aux1", "one_billion"))

```


```{r tax-revenue-to-delete}   
#DELETE?

# num_billionares_in <- round(400 * 1.8^1.4)
# top_tax_base <- 0.01 * ( 400 * ( (1-0.15) * 7.2 - 1 ) * 1.25 )
# Numbers in third bracket differ in 1 hhld 41636 instead of 4637
# numberTaxpayers <- c(640198, 171310, 41637, 24974, 5155, 2612, 911)
# 
    
# - inputs: cum_numberTaxpayers_dina_in, cum_numberTaxpayers_scf_in, num_billionares_in, cum_tax_base_dina_in, cum_tax_base_scf_in, brackets_po, starting_brack_po, main_tax_po
# - outputs: numberTaxpayers_mo, tax_base_mo, tax_base_dina_mo, tax_base_scf_mo, tax_base_total_mo, tax_rev_init_mo

#ADD COMMENTS
tax_revenue_mo_f <- function(cum_numberTaxpayers_dina_var = cum_numberTaxpayers_dina_in, cum_numberTaxpayers_scf_var = 
                               cum_numberTaxpayers_scf_in, num_billionares_var = num_billionares_in, 
                             cum_tax_base_dina_var = cum_tax_base_dina_in, cum_tax_base_scf_var =
                               cum_tax_base_scf_in, brackets_var = brackets_po, starting_brack_var = starting_brack_po,
                             main_tax_var = main_tax_po){
  
  
  
    aux1 <- (cum_numberTaxpayers_dina_var + cum_numberTaxpayers_scf_var)/2
    numberTaxpayers_mo <- c(-1 * diff(aux1, lag = 1), num_billionares_var)
    
    aux2 <- (cum_tax_base_dina_var + cum_tax_base_scf_var)/2
    tax_base_mo <- c(-1 * diff(aux2, lag = 1), top_tax_base_in) * 100
    
    tax_base_dina_mo <- cum_tax_base_dina_var[brackets_var == starting_brack_var]
    tax_base_scf_mo <- cum_tax_base_scf_var[brackets_var == starting_brack_var]
    
    #From here on: keep
    target_hhlds_mo <- sum( numberTaxpayers_mo[brackets_var>=starting_brack_var] )
   
    tax_base_total_mo <- sum(tax_base_mo[brackets_var>=starting_brack_var])/1000
    tax_rev_init_mo <-   tax_base_total_mo * main_tax_var * 1000
    
    
    
    return(list("numberTaxpayers_mo" = numberTaxpayers_mo, "tax_base_mo" = tax_base_mo, "tax_base_dina_mo" =
                  tax_base_dina_mo,  "tax_base_scf_mo" = tax_base_scf_mo, "target_hhlds_mo" = 
                  target_hhlds_mo, "tax_base_total_mo" = tax_base_total_mo, "tax_rev_init_mo" = tax_rev_init_mo))
}
invisible( list2env(tax_revenue_mo_f(),.GlobalEnv) )

# TO DELETE ONCE CODE CHUNCK ABOVE GO EVAL TRUE
# Temporary values to be used in next paragraph             
target_hhlds_round <- format(round( sum( 
  numberTaxpayers_mo[brackets_po>=starting_brack_po] )/1000 
  ) * 1000, scientific = FALSE)
target_hhlds_round_scf <- format(round( sum( 
  cum_numberTaxpayers_scf_in[brackets_po==starting_brack_po] )/1000 
  ) * 1000, scientific=FALSE)
target_hhlds_round_dina <- format(round( sum( 
  cum_numberTaxpayers_dina_in[brackets_po==starting_brack_po] )/1000 
  ) * 1000, scientific=FALSE)
```



In 2019, there would be around `r  target_hhlds_round` households liable to the wealth tax (`r target_hhlds_round_scf` households according to the SCF data and `r  target_hhlds_round_dina` tax filers according to the DINA data). In both cases, this would be less than `r paste0(round(target_hhlds_mo/total_hhlds_so * 100 , digits = 1), "%")` of the `r round(total_hhlds_so/1e7)*10` million US households in 2019. The tax base above `r paste("$", starting_brack_po/1e6, sep="")` million would be `r paste0("$", round(tax_base_scf_mo/10,1))` trillion based on the SCF data and `r paste("$", round(tax_base_dina_mo/10,1), sep="")` trillion based on the DINA data. Hence, the two data sources provide fairly close estimates, which we average as `r paste("$", round(tax_base_total_mo, digits = 1), sep="")` trillion, i.e. approximately 10% of the \$94 trillion population-wide total household net worth.



### 3.1 - Billionaires and their tax base over one billion [DISCUSS IF STIL RELEVANT]

```{r need to add, eval=FALSE}
final_taxbase_b_in
num_billionares_in
```


We estimate that in 2018, there were XXXX households with wealth above 1 billion dollars each, and a combined total wealth of XXXXX. That wealth is already paying a tax of 2% above 50million dollars and, under this proposal, it would pay an additional 1% for wealth above 1 billion dollars.Therefore, the billionaire surtax base is estimated at `r paste("$", round(final_taxbase_b_in/1e3, 2), sep="")` trillion, and it would apply to about `r round(num_billionares_in/100) * 100` billionaire families.


COMPLETE TOTAL REVENUE. 

```{r total-rev}
# - inputs: tax_rev_init_mo, top_tax_base_in
# - outputs: total_rev_pe
total_rev_mo_f <- function(tax_rev_init_var = tax_rev_init_mo, top_tax_base_var = top_tax_base_in) {
  
  
    total_rev_pe <- tax_rev_init_var + top_tax_base_var #PE
    
    
    return(list("total_rev_pe" = total_rev_pe))
}
invisible( list2env(total_rev_mo_f(),.GlobalEnv) )
```


Starting with the `r paste("$", round(tax_base_total_mo, digits = 1), sep="")` trillion tax base of wealth above `r paste0("$", starting_brack_po/1e6)` million, a two percent tax would raise `r paste("$", round(tax_rev_init_mo), sep="")` billion in 2019. The billionaire surtax is estimated to apply to a base of `r paste("$", round(final_taxbase_b_in/1e3, 2), sep="")` trillion from about `r round(num_billionares_in/100) * 100` billionaire families. Thus the billionaire surtax would raise `r paste("$", round(top_tax_base_in), sep="")` billion in 2019. The combination of the `r paste(100*main_tax_po, "%", sep = "")` tax above `r paste("$",starting_brack_po/1e6, sep = "")` million and the billionaire surtax would raise `r paste(round(tax_rev_init_mo)," + ", round(top_tax_base_in), sep="")` = `r round(total_rev_pe)` billion in 2019. 

### 4.1 - Visualization

The figure below illustrates the distribution of wealth tax across the population:

```{r figure, warning=FALSE}
wealth_aux <- 10:1000 * 1e6

bracketNames <- c("$10m-$25m", "$25m-$50m", "$50m-$100m", "$100m-$250m", "250m-$500m", "$500m-$1bn", "1bn+")
#This function computes the total tax collected for a tax unit with wealth "wealth_var", applying "taxrates_var" to "brackets_var"
# - inputs: wealth, tax rates, brackets to tax
# - ouputs: total tax collected
getTaxRevenue <- function(wealth_var = wealth_aux, taxrates_var = tax_rates_po,
                          brackets_var = brackets_po) {
    ## expecting taxLevels in percentage
    # taxLevels <- taxLevels / 100
    if (length(brackets_var) != length(taxrates_var)){
      stop("Tax brackets and tax rates do not match")
    }
   # Compute max taxable wealth per bracket
    max_tax_per_brack <- c(diff(c(0, brackets_var)), 1e100)
   # Substract wealth minus tax bracket. If wealth above a given bracket (difference is larger than max taxable wealth), 
   # then assign max taxable wealth to that given bracket
    to_tax <- ifelse( wealth_var - c(0, brackets_var) > max_tax_per_brack, 
                      max_tax_per_brack, 
                      ( wealth_var - c(0,brackets_var) ) )   
   # If wealth if lower than a given bracket (difference between wealth and bracket is negative), then assign zero to that bracket  
    to_tax <- ifelse( to_tax<0, 0, to_tax )
    # Apply trax rates to each corresponding bracket and all together
    total_tax <- sum( to_tax * c(0, taxrates_var) )   
    return(total_tax)
}
  

xval <- seq(10e6, 1e9 + 1e8, by = 1e6)
    
#brackets_po <- c(0, 25, 50, 100, 250, 500, 1000) * 1e6
getGroup <- as.numeric(cut(xval, c(brackets_po, 1e12), include.lowest = TRUE))

toPlot <- cbind.data.frame(xval, getGroup)

toMatch <- cbind.data.frame(group = 1:7, tax = tax_rates_po)

toPlot2 <- merge(toPlot, toMatch, by.x = "getGroup", by.y = "group")

#lapply(x = 1:5, f(x,y), y = 6:10) = (1, 6:10); (2, 6:10);... ;(5, 6:10)  
toPlot2$averageInt <- sapply( toPlot2$xval, 
                              function(x) getTaxRevenue(wealth_var = x, 
                                                        taxrates_var = tax_rates_po, 
                                                        brackets_var = brackets_po) )

# Here is where the total tax payed by each individuals is transform into marginal tax rates
toPlot2$averageRate <- (toPlot2$averageInt / toPlot2$xval) * 100

toPlot2$id <- 1:nrow(toPlot2)
#browser()
#View(toPlot2)

#sapply( toPlot2$xval, function(x) getTaxRevenue(wealth_var = x, taxrates_var = tax_rates_po, brackets_var = brackets_po) )
 
##########
##########

#taxRate <- c(input$bracket1, input$bracket2, input$bracket3, input$bracket4, input$bracket5, input$bracket6, input$bracket7)
taxRate <- tax_rates_po *100

# These are mini data set that ggvis needs to create vertical lines
extra0 <- cbind.data.frame(x = rep(10e6, 2), y = c(0, taxRate[1]))
extra1 <- cbind.data.frame(x = rep(25e6, 2), y = c(0, taxRate[1]))
extra1b <- cbind.data.frame(x = rep(25e6, 2), y = c(0, taxRate[2]))
extra2 <- cbind.data.frame(x = rep(50e6, 2), y = c(0, taxRate[2]))
extra2b <- cbind.data.frame(x = rep(50e6, 2), y = c(0, taxRate[3]))

extra3 <- cbind.data.frame(x = rep(100e6, 2), y = c(0, taxRate[3]))
extra3b <- cbind.data.frame(x = rep(100e6, 2), y = c(0, taxRate[4]))

extra4 <- cbind.data.frame(x = rep(250e6, 2), y = c(0, taxRate[4]))
extra4b <- cbind.data.frame(x = rep(250e6, 2), y = c(0, taxRate[5]))
extra5 <- cbind.data.frame(x = rep(500e6, 2), y = c(0, taxRate[5]))
extra5b <- cbind.data.frame(x = rep(500e6, 2), y = c(0, taxRate[6]))
extra6 <- cbind.data.frame(x = rep(1e9, 2), y = c(0, taxRate[6]))
extra6b <- cbind.data.frame(x = rep(1e9, 2), y = c(0, taxRate[7]))

    
showMargin <- function(x) {
  # Walk through?
  # https://stackoverflow.com/questions/28396900/r-ggvis-html-function-failing-to-add-tooltip/28399656#28399656
  if (is.null(x)) return(NULL)
  data = toPlot2
  row <- data[data$id == x$id, ]
  paste0("Average Tax Rate: ", round(row$averageRate, 2), "%", sep = "")
}
    
    toPlot2$tax100 <- toPlot2$tax * 100
    
    toPlot2 %>%
      ggvis(x = ~xval, y = ~ tax100 ) %>%                                        # marginal tax
      layer_points() %>%
      layer_points(x = ~xval, y = ~averageRate, stroke := "red", key := ~id) %>%
      add_tooltip(showMargin, "hover") %>%
      layer_lines(x = ~xval, y = ~averageRate, stroke := "red") %>%
      layer_paths(data = extra1, ~x, ~y) %>%
      layer_paths(data = extra2, ~x, ~y) %>%
      layer_paths(data = extra3, ~x, ~y) %>%
      layer_paths(data = extra4, ~x, ~y) %>%
      layer_paths(data = extra5, ~x, ~y) %>%
      layer_paths(data = extra6, ~x, ~y) %>%
      layer_paths(data = extra0, ~x, ~y) %>%
      layer_paths(data = extra1b, ~x, ~y) %>%
      layer_paths(data = extra2b, ~x, ~y) %>%
      layer_paths(data = extra3b, ~x, ~y) %>%
      layer_paths(data = extra4b, ~x, ~y) %>%
      layer_paths(data = extra5b, ~x, ~y) %>%
      layer_paths(data = extra6b, ~x, ~y) %>%
      add_axis("x", title = "Wealth before taxes") %>%
      add_axis("y", title = "Tax rate (%)") %>%
      set_options(width = 1000, height = 500)

```



**[Click here](https://fhoces.shinyapps.io/demo/) to explore different policy proposals.**

**[Click here/ADD URL WHEN ALLOWED](NULL) to see how the assumptions of the analysis affect the results.**



### 5 - Ten year projections  (talk about removing rounding)

```{r ten-years} 
# - inputs: inflation_so, population_gr_so, real_growth_so, total_rev_pe, top_tax_base_in
# - ouputs: discount_rate_mo, ten_year_factor_mo, ten_year_revenue_pe, ten_year_top_tax_pe
ten_years_mo_f <- function(inflation_var = inflation_so, population_gr_var = population_gr_so,
                           real_growth_var = real_growth_so, total_rev_var = total_rev_pe, 
                           top_tax_base_var = top_tax_base_in){
    discount_rate_mo <- inflation_var + population_gr_so + real_growth_so  
    ten_year_factor_mo <- sum( ( 1 + discount_rate_mo )^( 0:9 ) ) 

    ten_year_revenue_pe <- round(total_rev_pe) * ten_year_factor_mo     
    #ten_year_revenue_pe <- total_rev_pe * ten_year_factor_mo                      #PE
    ten_year_top_tax_pe <- top_tax_base_var * ten_year_factor_mo          
    #ten_year_top_tax_pe <- top_tax_base_var * ten_year_factor_mo                  #PE
    return( list("discount_rate_mo" = discount_rate_mo, "ten_year_factor_mo" = ten_year_factor_mo, 
           "ten_year_revenue_pe" = ten_year_revenue_pe, "ten_year_top_tax_pe" = ten_year_top_tax_pe) )
}

invisible( list2env(ten_years_mo_f(),.GlobalEnv) )

#TO DELETE
ten_year_factor_round <- round(ten_year_factor_mo) 



# test to run from the beginning (only functions)
if (FALSE) {
    rm(list = ls()[!(ls() %in% ls(pattern = "_f\\b"))])
    invisible( list2env(call_params_f(), .GlobalEnv) )
    invisible( list2env(policy_f(), .GlobalEnv) )
    invisible( list2env(tax_elasticity_in_f(), .GlobalEnv) )
    invisible( list2env(est_billionares_in_f(), .GlobalEnv) )
    invisible( list2env(tax_revenue_mo_f(), .GlobalEnv) )
    invisible( list2env(total_rev_mo_f(), .GlobalEnv) )
    invisible( list2env(ten_years_mo_f(),.GlobalEnv) )
    sapply(ls(pattern = "_pe\\b"), get)
}
```

To project tax revenues over a 10-year horizon, we assume that nominal taxable wealth would grow at the same pace as the economy, at `r paste(100 * discount_rate_mo,"%", sep="")` per year as in standard projections of the Congressional Budget Office or the Joint Committee on Taxation. This growth is decomposed into 2.5% price, 1% population growth, and 2% of real growth per capita. This implies that tax revenue over the 10 years 2019-2028 is `r ten_year_factor_round` times the revenue raised in 2019[^4]. This uniform growth assumption is conservative as the wealth of the rich has grown substantially faster than average in recent decades. The estimates by Saez and Zucman[^5] show that, from 1980 to 2016, real wealth of the top 0.1% has grown at 5.3% per year on average, which is 2.8 points above the average real wealth growth of 2.5% per year. Average real wealth of the Forbes 400 has grown even faster at 7% per year, 4.5 points above the average. The historical gap in growth rates of top wealth vs. average wealth is larger than the proposed wealth tax. Therefore, even with the wealth tax, it is most likely that top wealth would continue to grow at least as fast as the average.  

This 10-year projection implies that revenue raised by the progressive wealth tax would be `r paste(ten_year_factor_round, " * ", round(total_rev_pe), sep="")` = `r paste("$", round(ten_year_revenue_pe), sep = "")` billion, rounded to `r paste("$", round(ten_year_revenue_pe/1e3, 2), sep = "")` trillion. Out of these `r paste("$", round(ten_year_revenue_pe/1e3, 2), sep = "")` trillion, the billionaire surtax would raise `r paste(round(top_tax_base_in), " * ", ten_year_factor_round, sep="")` = `r paste("$", round(ten_year_top_tax_pe), sep ="")`, rounded to `r paste("$", round(ten_year_top_tax_pe/1e3,1), sep ="")` trillion.  

It is important to emphasize that our computations assume that the wealth tax base is comprehensive with no major asset classes exempt from wealth taxation. Introducing exemptions for specific asset classes would reduce the revenue estimates both mechanically and dynamically as wealthy individuals would shift their wealth into tax exempt assets. Because your proposal does not include any large exemptions, we do not believe our revenue estimate needs to be adjusted.

### 6 - Wealth inequality
One of the key motivations for introducing a progressive wealth tax is to curb the
growing concentration of wealth. The top 0.1% wealth share has increased dramatically from about 7% in the late 1970s to around 20% in recent years. Conversely, the wealth share of the bottom 90% of families has declined from about 35% in the late 1970s to about 25% today. This fall has been primarily the consequence of increased debt for the bottom 90% (through mortgage refinance, consumer credit, and student loans). As a result, the top 0.1% today owns almost as much wealth as the bottom 90% of US families, which includes the vast majority of US families. 


### 7 - Tax burden on the wealthiest 0.1%

The estimates of Piketty, Saez, and Zucman (2018) show that the total burden (including all taxes both at the federal, state, and local levels) of the wealthiest 0.1% families is projected to be 3.2% of their wealth in 2019 (they have on average \$116 million in wealth, and pay total taxes of \$3.68 million). The proposed progressive wealth tax would add an extra \$1.27 million (or 1.1% of wealth) to their tax burden for a total tax burden (relative to wealth) of 4.3%.

In contrast, the bottom 99% families have a total tax burden of 7.2% relative to their wealth. Their tax burden relative to wealth is much higher than for the top 0.1% because the bottom 99% relies primarily on labor income, which bears tax but is not part of net worth. In contrast, the majority of the income of the top 0.1% wealthiest comes from returns to their wealth.


[SAMPLE TEXT]**Note:** Our analysis complies with the highest levels of transparency and reproducibilty for open policy analysis proposed by the Berkeley Initiative for Transparency in Social Sciences. We invite contributors and critics of this analysis to follow similar standards. 


<!--  
Info from spreadsheet: 

Numbers from stata program wealthtax.do [to be reproduced]  

We start from SCF 2016 inflated to 2019 and adding Forbes 400 2018.   

We start from DINA tax data 2016 inflated to 2019.  

To inflate, we assume `r paste(hhld_gr_so*100,"%", sep="")` # household growth per year, wealth inflated uniformly to match 2019 aggregate total of $94Tr). Uniform discount of `r paste((final_ela_in * 0.02 - 0.01)*100,"%", sep="")` to account for tax evasion/avoidance when wealth tax in place. 
  
To do:   
 - remove all the rounded values.  
 - Incorporate wealthtax.do.    
 - replace any remaining hard coded values.    
 - 
  -->


[^1]: Piketty, Thomas, Emmanuel Saez, and Gabriel Zucman, "Distributional National Accounts: Methods and Estimates for the United States", Quarterly Journal of Economics 133(2), 2018, 553-609. Data online at http://gabriel-zucman.eu/usdina/

[^2]: Seim, David. 2017. "Behavioral Responses to an Annual Wealth Tax: Evidence from Sweden", American Economic Journal: Economic Policy, 9(4), 395-421 and Jakobsen, Kristian, Katrine Jakobsen, Henrik Kleven and Gabriel Zucman. 2018. "Wealth Accumulation and Wealth Taxation: Theory and Evidence from Denmark" NBER working paper No. 24371, obtain small avoidance/evasion responses in the case of Sweden and Denmark in two countries with systematic third party reporting of wealth: a 1% wealth tax reduces reported wealth by less than 1%. Londono-Velez, Juliana and Javier Avila. "Can Wealth Taxation Work in Developing Countries? Quasi-Experimental Evidence from Colombia", UC Berkeley working paper, 2018 show medium size avoidance/evasion responses in the case of Colombia where enforcement is not as strong: a 1% wealth tax reduces reported wealth by about `r paste(ela3_1_so, "-", ela3_2_so,"%", sep="")`. The study for Switzerland, Brülhart, Marius, Jonathan Gruber, Matthias Krapf, and Kurt Schmidheiny."Taxing Wealth: Evidence from Switzerland," NBER working paper No. 22376, 2016 is an outlier that finds very large responses to wealth taxation in Switzerland: a 1% wealth tax lowers reported wealth by `r paste(ela4_1_so, "-", ela4_2_so,"%", sep="")`. This extremely large estimate is extrapolated from very small variations in wealth tax rates over time and across Swiss cantons and hence is not as compellingly identified as the other estimates based on large variations in the wealth tax rate. Switzerland has no systematic third party reporting of assets which can also make tax evasion responses larger than in Scandinavia.  Our `r paste(evasion_param_in * 100,"%", sep="")` tax avoidance/evasion response to a 2% wealth tax is based on the average across these four studies (2%*(.5+.5+2.5+28.5)/4=16%).

[^3]: We make the classical assumption that the tail of the wealth distribution is Pareto distributed. As the average wealth of the Forbes 400 (\$7.2b) is 3.4 times the threshold to belong to the Forbes 400 (\$2.1b), the corresponding Pareto parameter is a=3.4/(3.4-1)=1.4. Standard calculations imply that the extra tax base between \$1bn and \$1.8bn (relative to the tax base above \$1.8bn) is [(1.8/1)^(a-1)-1] =.27 or approximately 25%. The number of families above \$1bn is estimated as 400*(1.8/1)^a=911, or about 900. The important point is that the vast majority of the billionaire surtax base (over three quarters) is in the Forbes 400, for which we have relatively good estimates of net worth.

[^4]: With r=5.5%, we have [1+(1+r)+..+(1+r)^9]=[(1+r)^10-1]/r=`r round(sum((1 + 0.055)^(0:9)),1)`, approximately 13.

[^5]: Saez, Emmanuel and Gabriel Zucman, "Wealth Inequality in the United States since 1913: Evidence from Capitalized Income Tax Data", Quarterly Journal of Economics 131(2), 2016, 519-578, updated series available at http://gabriel-zucman.eu/usdina/